<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Record 5a ‚Äî Cook / Cool / Reheat & Serve (No Batch)</title>
<style>
  :root{
    --ink:#0f172a; --muted:#6b7280; --line:#cfd6dd; --grid:#e5eaf0; --head:#f6f8fb;
    --chip:#eef2f7; --brand:#0d6efd; --warn:#ffc107; --danger:#e11d48;
    --fs:13px;
  }
  @page{ size:A4 portrait; margin:10mm }
  html,body{margin:0;background:#e8f0f4;color:var(--ink);font:var(--fs)/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body{
    background-image:url("kitchen.jpg");
    background-size:cover;background-attachment:fixed;background-position:center;
  }
  .wash{position:fixed;inset:0;background:rgba(255,255,255,.9);z-index:-1}
  .wrap{max-width:1000px;margin:20px auto;padding:0 12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 28px rgba(2,6,23,.10);padding:14px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .btn{border:0;border-radius:12px;background:var(--chip);padding:9px 14px;font-weight:700;cursor:pointer;color:#0f172a;display:flex;align-items:center;gap:8px;box-shadow:0 2px 6px rgba(2,6,23,.06)}
  .btn:hover{filter:brightness(.97)}
  .btn--back{background:var(--warn)}
  .btn--primary{background:var(--brand);color:#fff}
  .btn--danger{background:var(--danger);color:#fff}
  h1{margin:8px 0 12px;font-size:20px;text-align:center}
  .meta{display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:center;margin:8px 0 14px}
  label{font-weight:700}
  input[type="date"],input[type="month"],input[type="text"],input[type="time"],input[type="number"]{
    border:1px solid var(--line);border-radius:10px;padding:8px 10px;min-width:150px;background:#fff
  }
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .addRow{padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
  table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  th,td{border-right:1px solid var(--grid);border-bottom:1px solid var(--grid);padding:6px 8px;background:#fff;vertical-align:middle}
  th:last-child,td:last-child{border-right:0}
  tr:last-child td{border-bottom:0}
  thead th{background:var(--head);text-align:center;font-size:12px}
  .num{width:80px}
  .time{width:90px}
  .small{font-size:12px;color:var(--muted)}
  .bad{outline:2px solid var(--danger); outline-offset:-2px; background:#fff5f6}
  .row-del{white-space:nowrap}
  @media print{ .toolbar{display:none} body{background:#fff} .wash{display:none} }
</style>
</head>
<body>
<div class="wash"></div>
<div class="wrap card">

  <!-- Toolbar -->
  <div class="toolbar">
    <a href="kitchen.html" class="btn btn--back">‚Üê Back</a>
    <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
    <button class="btn" id="btnClear">‚úñÔ∏è Clear</button>
    <button class="btn btn--primary" id="btnSave">üíæ Save</button>
    <div class="controls">
      <label for="archiveMonth">Month:</label>
      <input type="month" id="archiveMonth"/>
      <button class="btn" id="btnLoadMonth">üìÇ Load Month</button>
      <button class="btn" id="btnArchive">üì¶ Archive Month</button>
    </div>
  </div>

  <h1>Record 5a ‚Äî Cook / Cool / Reheat & Serve (No Batch)</h1>

  <!-- Meta -->
  <div class="meta">
    <div><label>Date:&nbsp;<input id="logDate" type="date"/></label></div>
    <div><label>Site:&nbsp;<input id="siteName" type="text" placeholder="Mother Duck Kitchen"/></label></div>
    <div class="small">Targets: Cook ‚â• 75 ¬∞C ¬∑ Cool to ‚â§ 5 ¬∞C within 6 hrs ¬∑ Reheat ‚â• 75 ¬∞C</div>
  </div>

  <div class="controls">
    <button class="addRow" id="btnAddRow">+ Add Row</button>
  </div>

  <!-- Log Grid -->
  <div class="table-wrap">
    <table id="grid">
      <thead>
        <tr>
          <th>Food / Dish</th>
          <th class="time">Cook Time</th>
          <th class="num">Cook ¬∞C</th>
          <th class="time">Cool Start</th>
          <th class="num">Start ¬∞C</th>
        </tr>
        <tr>
          <th></th>
          <th class="time">Reheat Time</th>
          <th class="num">Reheat ¬∞C</th>
          <th class="time">Serve Time</th>
          <th>Initials / Corrective Actions</th>
        </tr>
      </thead>
      <tbody id="rows">
        <!-- rows injected -->
      </tbody>
    </table>
  </div>

  <p class="small"><b>Validation:</b> cells highlight red if Cook < 75 ¬∞C, Reheat < 75 ¬∞C, or Start Cool > 5 ¬∞C after cooling (use Corrective Actions to note what you did).</p>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* ------------------  Firebase CONFIG  ------------------ */
/* Replace the values below with your Firebase console ‚ÄúUse a <script> tag‚Äù config */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();       // optional (use if you want to require login)
const db   = firebase.firestore();
/* ------------------------------------------------------- */

// OPTIONAL: block page until signed in (uncomment to require auth)
// auth.onAuthStateChanged(u => { if(!u) location.href='login.html'; });

/* ---------- Helpers ---------- */
const logDate  = document.getElementById('logDate');
const siteName = document.getElementById('siteName');
const rowsEl   = document.getElementById('rows');
const archiveMonth = document.getElementById('archiveMonth');

function ymd(date){ const d=new Date(date); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
function ym(date){ const d=new Date(date); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}`; }

/* ---------- Firestore paths ---------- */
const dayDoc = (dateStr)=> `record5a/${dateStr}`;
const monthDoc = (monthStr)=> `archives/record5a/${monthStr}`;

/* ---------- Row rendering ---------- */
function newRow(data={}){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>
      <input type="text" class="food" placeholder="e.g. Beef stew" value="${data.food||''}">
    </td>
    <td><input type="time" class="t-cook" value="${data.cookTime||''}"></td>
    <td><input type="number" step="0.1" class="c-cook" value="${data.cookTemp??''}"></td>
    <td><input type="time" class="t-cool-start" value="${data.coolStartTime||''}"></td>
    <td><input type="number" step="0.1" class="c-cool-start" value="${data.coolStartTemp??''}"></td>
  `;
  const tr2 = document.createElement('tr');
  tr2.innerHTML = `
    <td></td>
    <td><input type="time" class="t-reheat" value="${data.reheatTime||''}"></td>
    <td><input type="number" step="0.1" class="c-reheat" value="${data.reheatTemp??''}"></td>
    <td><input type="time" class="t-serve" value="${data.serveTime||''}"></td>
    <td class="row-del">
      <input type="text" class="initials" maxlength="3" placeholder="AB" value="${data.initials||''}" oninput="this.value=this.value.toUpperCase()">
      <div><input type="text" class="actions" placeholder="Corrective actions..." value="${data.actions||''}" style="width:100%"></div>
      <button class="btn btn--danger" type="button">Delete</button>
    </td>
  `;
  tr2.querySelector('button').addEventListener('click', ()=>{ tr.remove(); tr2.remove(); });
  // live validation
  [tr, tr2].forEach(row=>{
    row.addEventListener('input', ()=> validatePair(tr,tr2));
  });
  rowsEl.appendChild(tr);
  rowsEl.appendChild(tr2);
  validatePair(tr,tr2);
}

function validatePair(tr, tr2){
  const cook = tr.querySelector('.c-cook');
  const reheat = tr2.querySelector('.c-reheat');
  const coolStart = tr.querySelector('.c-cool-start');
  const bad = (el, cond)=> el && (el.classList.toggle('bad', !!cond));
  const vCook = parseFloat(cook?.value);
  const vReh  = parseFloat(reheat?.value);
  const vCoolS= parseFloat(coolStart?.value);
  bad(cook,  !(isFinite(vCook) && vCook>=75));
  bad(reheat,!(isFinite(vReh)  && vReh>=75));
  // Cool start temp should be dropping; flag if >5¬∞C AFTER full cooling period ‚Äî with 2-step cooling you could extend later.
  bad(coolStart, (isFinite(vCoolS) && vCoolS>5));
}

/* ---------- Gather & hydrate ---------- */
function gather(){
  const entries = [];
  const trs = Array.from(rowsEl.querySelectorAll('tr'));
  for(let i=0;i<trs.length;i+=2){
    const a = trs[i], b = trs[i+1];
    if(!b) continue;
    const food = a.querySelector('.food')?.value?.trim();
    const cookTime = a.querySelector('.t-cook')?.value;
    const cookTemp = parseFloat(a.querySelector('.c-cook')?.value);
    const coolStartTime = a.querySelector('.t-cool-start')?.value;
    const coolStartTemp = parseFloat(a.querySelector('.c-cool-start')?.value);
    const reheatTime = b.querySelector('.t-reheat')?.value;
    const reheatTemp = parseFloat(b.querySelector('.c-reheat')?.value);
    const serveTime  = b.querySelector('.t-serve')?.value;
    const initials   = b.querySelector('.initials')?.value?.trim().toUpperCase();
    const actions    = b.querySelector('.actions')?.value?.trim();
    // skip truly empty rows
    if(!(food||cookTime||isFinite(cookTemp)||reheatTime||isFinite(reheatTemp)||serveTime||initials||actions)) continue;
    entries.push({food,cookTime,cookTemp,coolStartTime,coolStartTemp,reheatTime,reheatTemp,serveTime,initials,actions});
  }
  return entries;
}

function hydrate(rows=[]){
  rowsEl.innerHTML='';
  rows.forEach(r=> newRow(r));
}

/* ---------- Firestore R/W ---------- */
async function saveDay(){
  const d = logDate.value;
  if(!d){ alert('Pick a Date first'); return; }
  const key = ymd(d);
  const rows = gather();
  await db.doc(dayDoc(key)).set({
    site: siteName.value || 'Mother Duck Kitchen',
    date: key,
    rows,
    savedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, {merge:true});
  alert('Saved to Firestore.');
}

async function loadDay(dateStr){
  rowsEl.innerHTML = '';
  const snap = await db.doc(dayDoc(dateStr)).get();
  if(!snap.exists){ return; }
  const data = snap.data();
  siteName.value = data.site || siteName.value;
  hydrate(Array.isArray(data.rows)? data.rows : []);
}

async function archiveMonthData(){
  const m = archiveMonth.value;
  if(!m){ alert('Choose Month'); return; }
  const first = new Date(m + "-01T00:00:00");
  const next  = new Date(first); next.setMonth(next.getMonth()+1);
  // Query day docs inside month (date is ISO string so lexicographic works)
  const q = await db.collection('record5a')
    .where('date','>=', ymd(first))
    .where('date','<',  ymd(next))
    .get();
  const days = [];
  q.forEach(doc=> days.push(doc.data()));
  await db.doc(monthDoc(m)).set({
    month: m,
    site: siteName.value || 'Mother Duck Kitchen',
    days,
    archivedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert(`Archived ${days.length} day(s) to ${m}.`);
}

async function loadArchive(){
  const m = archiveMonth.value;
  if(!m){ alert('Choose Month'); return; }
  const doc = await db.doc(monthDoc(m)).get();
  if(!doc.exists){ alert('No archive for that month.'); return; }
  const data = doc.data();
  // Simple printable window
  const w = window.open('', '_blank');
  const css = `
    body{font-family:system-ui,Segoe UI,Arial;margin:20px}
    h2{margin:0 0 10px} h3{margin:12px 0 6px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #cfd6dd;padding:6px 8px}
    thead th{background:#f6f8fb}
    .cent{text-align:center}
  `;
  w.document.write(`<html><head><title>5a Archive ${m}</title><style>${css}</style></head><body>`);
  w.document.write(`<h2>Record 5a ‚Äî Archive ${m}</h2><p><b>Site:</b> ${data.site||''}</p>`);
  (data.days||[]).sort((a,b)=> (a.date||'').localeCompare(b.date||''));
  (data.days||[]).forEach(day=>{
    w.document.write(`<h3>Date ${day.date}</h3>`);
    w.document.write('<table><thead><tr><th>Food</th><th>Cook Time</th><th>Cook ¬∞C</th><th>Cool Start</th><th>Start ¬∞C</th><th>Reheat Time</th><th>Reheat ¬∞C</th><th>Serve</th><th>Initials</th><th>Actions</th></tr></thead><tbody>');
    (day.rows||[]).forEach(r=>{
      const row = [
        r.food||'',
        r.cookTime||'',
        (isFinite(r.cookTemp)? r.cookTemp : ''),
        r.coolStartTime||'',
        (isFinite(r.coolStartTemp)? r.coolStartTemp : ''),
        r.reheatTime||'',
        (isFinite(r.reheatTemp)? r.reheatTemp : ''),
        r.serveTime||'',
        r.initials||'',
        r.actions||''
      ];
      w.document.write(`<tr>${row.map((v,i)=> i? `<td class="cent">${v}</td>` : `<td>${v}</td>`).join('')}</tr>`);
    });
    w.document.write('</tbody></table>');
  });
  w.document.write('</body></html>'); w.document.close(); w.focus();
}

/* ---------- Events & defaults ---------- */
document.getElementById('btnAddRow').addEventListener('click', ()=> newRow());
document.getElementById('btnSave').addEventListener('click', saveDay);
document.getElementById('btnArchive').addEventListener('click', archiveMonthData);
document.getElementById('btnLoadMonth').addEventListener('click', loadArchive);
document.getElementById('btnClear').addEventListener('click', ()=>{
  rowsEl.innerHTML = '';
});

logDate.addEventListener('change', ()=>{
  const key = ymd(logDate.value);
  if(key) loadDay(key);
});

(function init(){
  const today = new Date();
  logDate.value = ymd(today);
  archiveMonth.value = ym(today);
  siteName.value = 'Mother Duck Kitchen';
  loadDay(ymd(today));
  // Add a starter row
  newRow();
})();
</script>
</body>
</html>
